id: t05_replace_installed_part
name: Repair with recharge and tool retrieval
description: |
  The robot starts at the dock with an empty battery. Recharge, retrieve the tool
  from a bin in the cell, move to the bench, remove the wrong part, place it on
  the bench, then align and fasten the correct part.

meta:
  domain: assembly
  enable_numeric: true
  enable_conditional: true
  enable_durations: true
  enable_stochastic: false
  max_steps: 30
  init_fluents:
    - ["battery-cap", ["robot"], 8]
    - ["energy", ["robot"], 0]
  reward_shaping:
    mode: instant
    milestones:
      - {expr: "(>= (energy robot) 5)", reward: 0.15, once: true}
      - {expr: "(open bin)",            reward: 0.10, once: true}
      - {expr: "(holding robot tool)",  reward: 0.10, once: true}
      - {expr: "(equipped robot tool)", reward: 0.10, once: true}
      - {expr: "(not (fastened bad asm))", reward: 0.20, once: true}
      - {expr: "(holding robot bad)",   reward: 0.15, once: true}
      - {expr: "(aligned good asm)",    reward: 0.20, once: true}

objects:
  robot: {types: [robot],    variants: [r1, bot, assembler]}
  dock:  {types: [location], variants: [dock, charger, bay]}
  cell:  {types: [location], variants: [cell, workstation, cellA]}
  bench: {types: [location], variants: [bench, workbench, table]}
  bin:   {types: [container], variants: [bin1, tote, crate, box]}
  tool:  {types: [tool],     variants: [drv, screwdriver, driver, wrench]}
  bad:   {types: [part],     variants: [p_bad, bad_part, defective, scrap]}
  good:  {types: [part],     variants: [p_good, spare, good_part, p_ok]}
  asm:   {types: [assembly], variants: [asm1, frame, chassis]}

static_facts:
  - (tool-for tool asm)
  - (adjacent dock cell)
  - (adjacent cell dock)
  - (adjacent cell bench)
  - (adjacent bench cell)
  - (has-charger dock)

init:
  - (at robot dock)
  - (obj-at bin cell)
  - (in tool bin)
  - (obj-at good bench)
  - (obj-at asm bench)
  - (obj-at bad bench)
  - (fastened bad asm)
  - (installed bad asm)
  - (clear-hand robot)

termination:
  - name: goal
    all:
      - "(installed good asm)"
      - "(fastened good asm)"
      - "(obj-at bad bench)"
      - "(not (installed bad asm))"
      - "(not (fastened bad asm))"
    outcome: success
    reward: 1.0

reference_plan:
  - (recharge robot dock)
  - (move robot dock cell)
  - (open robot bin)
  - (take-out robot tool bin)
  - (equip-tool robot tool)
  - (move robot cell bench)
  - (unfasten robot bad asm tool)
  - (place-on-bench robot bad)
  - (align robot good asm)
  - (fasten robot good asm tool)
