domain: assembly
requirements: [":strips", ":typing"]

# ---------- Types ----------
types:
  - name: robot
  - name: location
  - name: object
  - name: container
    parent: object
  - name: tool
    parent: object
  - name: part
    parent: object
  - name: assembly
    parent: object
  - name: machine
    parent: object
  - name: number

# ---------- Predicates ----------
predicates:
  # spatial / kinematic
  - name: at
    args: [{name: r, type: robot}, {name: l, type: location}]
    nl: "{r} is at {l}"

  - name: obj-at
    args: [{name: o, type: object}, {name: l, type: location}]
    nl: "{o} is at {l}"

  - name: co-located
    args: [{name: x, type: object}, {name: y, type: object}]
    nl: "{x} and {y} are at the same location"

  - name: adjacent
    args: [{name: l1, type: location}, {name: l2, type: location}]
    static: true
    nl: "{l1} is adjacent to {l2}"

  # grasping / hand state
  - name: holding
    args: [{name: r, type: robot}, {name: o, type: object}]
    nl: "{r} is holding {o}"

  - name: clear-hand
    args: [{name: r, type: robot}]
    nl: "{r} has a free hand"

  # containers & openness
  - name: in
    args: [{name: o, type: object}, {name: c, type: container}]
    nl: "{o} is in {c}"

  - name: open
    args: [{name: c, type: container}]
    nl: "{c} is open"

  # tools & equipment state
  - name: equipped
    args: [{name: r, type: robot}, {name: t, type: tool}]
    nl: "{r} has {t} equipped"

  - name: tool-for
    args: [{name: t, type: tool}, {name: op, type: object}]
    static: true
    nl: "{t} is suitable for {op}"

  # assembly relations
  - name: aligned
    args: [{name: p, type: part}, {name: a, type: assembly}]
    nl: "{p} is aligned with {a}"

  - name: installed
    args: [{name: p, type: part}, {name: a, type: assembly}]
    nl: "{p} is installed on {a}"

  - name: fastened
    args: [{name: p, type: part}, {name: a, type: assembly}]
    nl: "{p} is fastened to {a}"

  - name: damaged
    args: [{name: o, type: object}]
    nl: "{o} is damaged"

  # infrastructure / facilities
  - name: has-charger
    args: [{name: l, type: location}]
    static: true
    nl: "{l} has a charging station"

  - name: has-fixture
    args: [{name: l, type: location}]
    static: true
    nl: "{l} has a vise/fixture"

  # machines
  - name: powered
    args: [{name: m, type: machine}]
    nl: "{m} is powered"

  # quality of outcome
  - name: defective
    args: [{name: a, type: assembly}]
    nl: "{a} is defective"

  - name: needs-rework
    args: [{name: a, type: assembly}]
    nl: "{a} needs rework"

# ---------- Fluents (numeric state) ----------
fluents:
  - name: battery-cap
    args: [{name: r, type: robot}]
    nl: "Battery capacity of {r}"

  - name: energy
    args: [{name: r, type: robot}]
    nl: "Energy of {r}"

  - name: torque
    args: [{name: t, type: tool}]
    nl: "Torque setting on {t}"

  - name: quality
    args: [{name: a, type: assembly}]
    nl: "Quality score of {a}"

# ---------- Actions ----------
actions:

  - name: wait
    params: [{n: number}]
    pre: []
    add: []
    del: []
    duration_var: "n"
    duration_unit: 1.0
    nl: "Wait for {n} ticks"
    outcomes:
      - name: fail
        status: fail
        p: 0.0
        when: []
        add: []
        delete: []
        messages:
          - "Time passed but nothing changed."
      - name: success
        status: success
        p: 1.0
        when: []
        add: []
        delete: []
        messages:
          - "Waited {n} ticks."

  # movement / navigation
  - name: move
    params: [{r: robot}, {from: location}, {to: location}]
    pre:
      - "(at ?r ?from)"
      - "(adjacent ?from ?to)"
      - "(>= (energy ?r) 1)"
      - "(distinct ?from ?to)"
    add: []
    del: []
    duration: 1.0
    nl: "Move {r} from {from} to {to}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.1)"]
        messages:
          - "{r} tried to move from {from} to {to} but got stuck."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(at ?r ?to)"]
        delete: ["(at ?r ?from)"]
        num_eff: ["(decrease (energy ?r) 1)"]
        messages:
          - "{r} moved from {from} to {to}. Energy is now (energy ?r)."

  - name: open
    params: [{r: robot}, {c: container}]
    pre: ["(co-located ?r ?c)", "(not (open ?c))"]
    add: []
    del: []
    duration: 0.3
    nl: "Open {c}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Failed to open {c}."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(open ?c)"]
        delete: []
        num_eff: ["(decrease (energy ?r) 0.2)"]
        messages:
          - "{c} is now open."

  - name: close
    params: [{r: robot}, {c: container}]
    pre: ["(co-located ?r ?c)", "(open ?c)"]
    add: []
    del: []
    duration: 0.3
    nl: "Close {c}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Failed to close {c}."
      - name: success
        status: success
        p: 0.95
        when: []
        add: []
        delete: ["(open ?c)"]
        num_eff: ["(decrease (energy ?r) 0.2)"]
        messages:
          - "{c} is now closed."

  - name: pick-up
    params: [{r: robot}, {o: object}]
    pre: ["(co-located ?r ?o)", "(clear-hand ?r)"]
    add: []
    del: []
    duration: 0.5
    nl: "Pick up {o}"
    outcomes:
      - name: fail
        status: fail
        p: 0.10
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "You fumbled {o}."
      - name: success
        status: success
        p: 0.90
        when: []
        add: ["(holding ?r ?o)"]
        delete: ["(obj-at ?o ?l)", "(clear-hand ?r)"]
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "Picked up {o}."

  - name: put-down
    params: [{r: robot}, {o: object}]
    pre: ["(holding ?r ?o)"]
    add: []
    del: []
    duration: 0.5
    nl: "Put down {o}"
    outcomes:
      - name: fail
        status: fail
        p: 0.07
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "{o} slipped; still in hand."
      - name: success
        status: success
        p: 0.93
        when: []
        add: ["(obj-at ?o ?l)", "(clear-hand ?r)"]
        delete: ["(holding ?r ?o)"]
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "Placed {o} down."

  - name: put-in
    params: [{r: robot}, {o: object}, {c: container}]
    pre: ["(co-located ?r ?c)", "(holding ?r ?o)", "(open ?c)"]
    add: []
    del: []
    duration: 0.5
    nl: "Put {o} into {c}"
    outcomes:
      - name: fail
        status: fail
        p: 0.10
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Missed the opening on {c}."
      - name: success
        status: success
        p: 0.90
        when: []
        add: ["(in ?o ?c)", "(clear-hand ?r)"]
        delete: ["(holding ?r ?o)", "(obj-at ?o ?l)"]
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "{o} is now in {c}."

  - name: take-out
    params: [{r: robot}, {o: object}, {c: container}]
    pre: ["(co-located ?r ?c)", "(in ?o ?c)", "(open ?c)", "(clear-hand ?r)"]
    add: []
    del: []
    duration: 0.5
    nl: "Take {o} out of {c}"
    outcomes:
      - name: fail
        status: fail
        p: 0.10
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "You couldn’t get a grip on {o} in {c}."
      - name: success
        status: success
        p: 0.90
        when: []
        add: ["(holding ?r ?o)"]
        delete: ["(in ?o ?c)", "(clear-hand ?r)"]
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "Took {o} out of {c}."

  - name: equip-tool
    params: [{r: robot}, {t: tool}]
    pre: ["(holding ?r ?t)"]
    add: []
    del: []
    duration: 0.4
    nl: "Equip {t}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Failed to equip {t}."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(equipped ?r ?t)", "(clear-hand ?r)"]
        delete: ["(holding ?r ?t)"]
        num_eff: ["(decrease (energy ?r) 0.2)"]
        messages:
          - "{t} equipped."

  - name: unequip-tool
    params: [{r: robot}, {t: tool}]
    pre: ["(equipped ?r ?t)", "(clear-hand ?r)"]
    add: []
    del: []
    duration: 0.4
    nl: "Unequip {t}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Failed to unequip {t}."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(holding ?r ?t)"]
        delete: ["(equipped ?r ?t)", "(clear-hand ?r)"]
        num_eff: ["(decrease (energy ?r) 0.2)"]
        messages:
          - "{t} unequipped."

  - name: align
    params: [{r: robot}, {p: part}, {a: assembly}]
    pre: ["(co-located ?r ?p)", "(co-located ?r ?a)"]
    add: []
    del: []
    duration: 1.0
    nl: "Align {p} with {a}"
    outcomes:
      - name: fail
        status: fail
        p: 0.10
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.1)"]
        messages:
          - "Failed to align {p} with {a}."
      - name: success
        status: success
        p: 0.90
        when: []
        add: ["(aligned ?p ?a)"]
        delete: []
        num_eff: ["(decrease (energy ?r) 0.5)"]
        messages:
          - "{p} aligned with {a}."

  - name: fasten
    params: [{r: robot}, {p: part}, {a: assembly}, {t: tool}]
    pre: ["(equipped ?r ?t)", "(tool-for ?t ?a)", "(aligned ?p ?a)", "(co-located ?r ?p)", "(co-located ?r ?a)"]
    # Base effects first so cond can override when damaged
    add: ["(fastened ?p ?a)", "(installed ?p ?a)"]
    del: []
    duration: 2.0
    nl: "Fasten {p} to {a}"
    cond:
      - when: ["(damaged ?p)"]
        add: []
        delete: ["(installed ?p ?a)"]
        num_eff: []
        messages: []
    outcomes:
      - name: hard_defect
        status: fail
        p: 0.10
        when: []
        add: ["(defective ?a)"]
        delete: []
        num_eff: ["(assign (quality ?a) 0.20)", "(decrease (energy ?r) 1.0)"]
        messages:
          - "QC: Hard defect on {a} detected. Disassemble and reassemble."
      - name: soft_defect
        status: fail
        p: 0.30
        when: []
        add: ["(needs-rework ?a)"]
        delete: []
        num_eff: ["(assign (quality ?a) 0.65)", "(decrease (energy ?r) 1.0)"]
        messages:
          - "QC: Marginal quality on {a}. Rework needed."
      - name: success
        status: success
        p: 0.60
        when: []
        add: []
        delete: ["(defective ?a)", "(needs-rework ?a)"]
        num_eff: ["(assign (quality ?a) 0.95)", "(decrease (energy ?r) 1.0)"]
        messages:
          - "QC: {a} passed. Quality=good."

  - name: set-torque
    params: [{r: robot}, {t: tool}, {lvl: object}]
    pre: ["(equipped ?r ?t)"]
    add: []
    del: []
    duration: 0.2
    nl: "Set torque on {t} to {lvl}"
    outcomes:
      - name: fail
        status: fail
        p: 0.00
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "Torque dial slipped; setting unchanged."
      - name: success
        status: success
        p: 1.00
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.1)"]
        messages:
          - "Torque on {t} set to {lvl}."

  - name: unfasten
    params: [{r: robot}, {p: part}, {a: assembly}, {t: tool}]
    pre: ["(equipped ?r ?t)", "(tool-for ?t ?a)", "(fastened ?p ?a)", "(co-located ?r ?p)", "(co-located ?r ?a)", "(clear-hand ?r)"]
    add: []
    del: []
    duration: 2.0
    nl: "Unfasten {p} from {a}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.1)"]
        messages:
          - "Could not break {p} loose from {a}."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(holding ?r ?p)"]
        delete: ["(fastened ?p ?a)", "(installed ?p ?a)", "(clear-hand ?r)"]
        num_eff: ["(decrease (energy ?r) 1.0)"]
        messages:
          - "Unfastened {p} from {a}; now holding {p}."

  - name: place-on-bench
    params: [{r: robot}, {o: object}]
    pre: ["(holding ?r ?o)"]
    add: []
    del: []
    duration: 0.5
    nl: "Place {o} on the bench"
    outcomes:
      - name: fail
        status: fail
        p: 0.00
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "You hesitated; still holding {o}."
      - name: success
        status: success
        p: 1.00
        when: []
        add: ["(obj-at ?o ?l)", "(clear-hand ?r)"]
        delete: ["(holding ?r ?o)"]
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "Placed {o} on the bench."

  - name: power-on
    params: [{r: robot}, {m: machine}]
    pre: ["(co-located ?r ?m)", "(not (powered ?m))"]
    add: []
    del: []
    duration: 0.5
    nl: "Power on {m}"
    outcomes:
      - name: fail
        status: fail
        p: 0.05
        when: []
        add: []
        delete: []
        num_eff: ["(decrease (energy ?r) 0.05)"]
        messages:
          - "Power button on {m} didn’t register."
      - name: success
        status: success
        p: 0.95
        when: []
        add: ["(powered ?m)"]
        delete: []
        num_eff: ["(decrease (energy ?r) 0.2)"]
        messages:
          - "{m} is now powered."

  - name: recharge
    params: [{r: robot}, {l: location}]
    pre: ["(at ?r ?l)", "(has-charger ?l)"]
    add: []
    del: []
    duration: 2.0
    nl: "Recharge at {l}"
    outcomes:
      - name: fail
        status: fail
        p: 0.02
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "Charger at {l} didn’t connect properly."
      - name: success
        status: success
        p: 0.98
        when: []
        add: []
        delete: []
        num_eff: ["(increase (energy ?r) 5)"]
        messages:
          - "{r} recharged at {l}. Energy is now (energy ?r)."

  - name: qc-check
    params: [{r: robot}, {a: assembly}]
    pre: ["(co-located ?r ?a)"]
    add: []
    del: []
    duration: 0.2
    nl: "QC check for {a}"
    outcomes:
      - name: fail
        status: fail
        p: 0.00
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "QC device not responding."
      - name: success
        status: success
        p: 1.00
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "QC Report for {a} — quality=(quality ?a), flags: (defective ?a) (needs-rework ?a)"

  - name: realign
    params: [{r: robot}, {p: part}, {a: assembly}]
    pre: ["(co-located ?r ?p)", "(co-located ?r ?a)"]
    add: []
    del: []
    duration: 0.5
    nl: "Realign {p} with {a}"
    outcomes:
      - name: fail
        status: fail
        p: 0.00
        when: []
        add: []
        delete: []
        num_eff: []
        messages:
          - "Adjustment failed; alignment unchanged."
      - name: success
        status: success
        p: 1.00
        when: []
        add: ["(aligned ?p ?a)"]
        delete: []
        num_eff: ["(decrease (energy ?r) 0.3)"]
        messages:
          - "Realigned {p} with {a}."
